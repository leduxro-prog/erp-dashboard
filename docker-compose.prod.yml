# ==============================================================================
# Cypher ERP - Production Docker Compose Configuration
# ==============================================================================
#
# This file contains production-ready configurations for Cypher ERP deployment.
# Use this configuration for staging and production environments.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml ps
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml logs -f
#
# Environment Variables Required:
#   - DB_PASSWORD: Strong database password
#   - JWT_SECRET: Strong JWT secret key
#   - REDIS_PASSWORD: Redis password
#   - RABBITMQ_USER: RabbitMQ username
#   - RABBITMQ_PASSWORD: RabbitMQ password
#
# ==============================================================================

services:
  # ==============================================================================
  # Frontend (Nginx + React/Vite)
  # ==============================================================================
  frontend:
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.frontend.rule=Host(`erp.cypher.ro`)"
        - "traefik.http.routers.frontend.tls=true"
        - "traefik.http.routers.frontend.tls.certresolver=letsencrypt"
        - "com.cypher.service=frontend"
        - "com.cypher.environment=production"
        - "com.cypher.monitoring.enabled=true"
    environment:
      - NODE_ENV=production
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # CYPHER ERP Application
  # ==============================================================================
  app:
    deploy:
      mode: replicated
      replicas: 3
      update_config:
        parallelism: 1
        delay: 30s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
        failure_action: continue
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 180s
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.api.rule=Host(`api.cypher.ro`)"
        - "traefik.http.routers.api.tls=true"
        - "traefik.http.routers.api.tls.certresolver=letsencrypt"
        - "traefik.http.middlewares.api-stripprefix.stripprefix.prefixes=/api"
        - "com.cypher.service=app"
        - "com.cypher.environment=production"
        - "com.cypher.monitoring.enabled=true"
        - "com.cypher.version=${VERSION:-latest}"
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=warn
      - DB_SSL=true
      - DB_POOL_MIN=5
      - DB_POOL_MAX=20
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "20"
        labels: "service,environment,version"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # PostgreSQL Database
  # ==============================================================================
  db:
    image: postgres:15-alpine
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
      labels:
        - "com.cypher.service=database"
        - "com.cypher.environment=production"
        - "com.cypher.backup.enabled=true"
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=512MB"
      - "-c"
      - "effective_cache_size=2GB"
      - "-c"
      - "maintenance_work_mem=128MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=2621kB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
    environment:
      - POSTGRES_HOST_AUTH_METHOD=scram-sha-256
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # Redis Cache
  # ==============================================================================
  redis:
    image: redis:7-alpine
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 5
        window: 60s
      labels:
        - "com.cypher.service=redis"
        - "com.cypher.environment=production"
        - "com.cypher.monitoring.enabled=true"
    command: >
      sh -c 'if [ -n "$$REDIS_PASSWORD" ]; then
        redis-server --appendonly yes --requirepass "$$REDIS_PASSWORD" --maxmemory 400mb --maxmemory-policy allkeys-lru;
      else
        redis-server --appendonly yes --maxmemory 400mb --maxmemory-policy allkeys-lru;
      fi'
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # MeiliSearch - High Performance Search Engine
  # ==============================================================================
  meilisearch:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
      labels:
        - "com.cypher.service=meilisearch"
        - "com.cypher.environment=production"
        - "com.cypher.monitoring.enabled=true"
    environment:
      - MEILI_ENV=production
      - MEILI_NO_ANALYTICS=true
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # PgAdmin - Database Management UI
  # ==============================================================================
  pgadmin:
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 60s
      labels:
        - "com.cypher.service=pgadmin"
        - "com.cypher.environment=production"
    environment:
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # AI Agents Service
  # ==============================================================================
  ai-service:
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 3
        window: 120s
      labels:
        - "com.cypher.service=ai-service"
        - "com.cypher.environment=production"
        - "com.cypher.monitoring.enabled=true"
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # RabbitMQ - Event Bus (Production)
  # ==============================================================================
  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: cypher-rabbitmq-prod
    hostname: rabbitmq-prod

    ports:
      - "5672:5672"
      - "15672:15672"
      - "15692:15692"

    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-strong_password_change_in_production}
      RABBITMQ_DEFAULT_VHOST: /

      # Production memory and disk settings
      RABBITMQ_VM_MEMORY_HIGH_WATERMARK: 0.6
      RABBITMQ_DISK_FREE_LIMIT: 2GB

      # Enable cluster plugins
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: >-
        -rabbit log_levels [{connection,error},{default,warning}]
        -rabbitmirroring sync_mode automatic

    volumes:
      - rabbitmq-prod-data:/var/lib/rabbitmq
      - rabbitmq-prod-config:/etc/rabbitmq

    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

    networks:
      - cypher-network

    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 5
        window: 180s

      labels:
        - "com.cypher.service=rabbitmq"
        - "com.cypher.environment=production"
        - "com.cypher.monitoring.enabled=true"

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

  # ==============================================================================
  # Traefik Reverse Proxy (Optional - for production)
  # ==============================================================================
  traefik:
    image: traefik:v2.10
    container_name: cypher-traefik
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=admin@cypher.ro"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--log.level=INFO"
      - "--accesslog=true"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.entrypoint=metrics"
      - "--entryPoints.metrics.address=:8080"

    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-letsencrypt:/letsencrypt

    networks:
      - cypher-network

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 60s

    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
        labels: "service,environment"
        tag: "{{.Name}}/{{.ID}}"

# ==============================================================================
# Networks
# ==============================================================================
networks:
  cypher-network:
    name: cypher-network-prod
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/16
    labels:
      - "com.cypher.network=production"

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  db-data:
    name: cypher-db-prod-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/cypher-erp/db

  redis-data:
    name: cypher-redis-prod-data
    driver: local

  meili-data:
    name: cypher-meili-prod-data
    driver: local

  pgadmin-data:
    name: cypher-pgadmin-prod-data
    driver: local

  rabbitmq-prod-data:
    name: cypher-rabbitmq-prod-data
    driver: local

  rabbitmq-prod-config:
    name: cypher-rabbitmq-prod-config
    driver: local

  traefik-letsencrypt:
    name: cypher-traefik-letsencrypt
    driver: local
